(load "./v2/marmalade.repl")
(load "../oracle/price.repl")

(begin-tx "create collection")

(env-keys ["ku-admin" "ku-ops" "ku-bank" "creatorGuard"])
(env-data
  {
    "ku-admin": {
      "keys": [
        "ku-admin"
      ],
      "pred": "keys-any"
    },
    "ku-ops": {
      "keys": [
        "ku-ops"
      ],
      "pred": "keys-any"
    },
    "ku-bank": {
      "keys": [
        "ku-bank"
      ],
      "pred": "keys-all"
    },
    "bank-guard": {
      "keys": [
        "ku-admin"
      ],
      "pred": "keys-all"
    },
      "collection": {
      "name": "test-collection",
      "creator": "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce",
      "creatorGuard": {
        "keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce", "2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"],
        "pred": "keys-any"
      },
      "description": "test-description",
      "tiers": [
         {
          "tierId": "tier0",
          "tierType": "PUBLIC",
          "startTime": {"time": "2023-01-03T20:00:00Z"},
          "endTime": {"time": "2024-01-03T00:00:00Z"},
          "cost": 50.0,
          "limit": -1,
          "currencyType": "USD"
        },
        {
          "tierId": "tier1",
          "tierType": "WL",
          "startTime": {"time": "2024-01-04T00:00:01Z"},
          "endTime": {"time": "2024-01-09T00:00:00Z"},
          "cost": 0.0,
          "limit": 2,
          "currencyType": "KDA"
        }
        ;  {
        ;    "tierId": "tier2",
        ;    "tierType": "PUBLIC",
        ;    "startTime": {"time": "2024-01-10T00:00:00Z"},
        ;    "endTime": {"time": "2024-01-11T00:00:00Z"},
        ;    "cost": 5.0,
        ;    "limit": 2,
        ;    "currencyType": "KDA"
        ;  }
      ]
    },
    "upgrade": false
  }
)
(load "kadenai-create-v2.pact")
(env-keys ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"])


(env-gasmodel "table") (env-gaslimit 1500000) (env-gas 0) 
(free.kadenai-create-v2.create-collection (read-msg 'collection) 10 coin)  
(env-gas)

(commit-tx)

(begin-tx "Add Bank Account")
(env-keys ["ku-ops"])
(coin.create-account "KAIBANK" (read-keyset "ku-bank"))
(free.kadenai-create-v2.update-bank "BANK" "KAIBANK")
 (commit-tx)


(begin-tx "Alice Mint")
(env-chain-data { "block-time": (time "2023-01-03T20:00:00Z")})
(env-keys ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"])
(env-sigs
[{
  "key": "048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce",
  "caps": [
      (coin.TRANSFER "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" (free.kadenai-create-v2.get-SPLITTER-account) 150.0)
  ]
}])

(free.kadenai-create-v2.reserve-mint "test-collection" "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" 1)
;  (env-gas "table")
(expect-that "Amounts were transferred"
  (= [995.0 5.0 1045.0])
  [
    (coin.get-balance "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce")
    (coin.get-balance "KAIBANK")
    (coin.get-balance "bob")
  ]
)

(commit-tx)

(begin-tx "2cd Mint")
(env-chain-data { "block-time": (time "2023-01-03T20:00:00Z")})
(env-keys ["2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"])
(env-sigs
[{
  "key": "2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652",
  "caps": [
      (coin.TRANSFER "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" (free.kadenai-create-v2.get-SPLITTER-account) 80.0)
  ]
}])
; Mint price of 50.0
(free.kadenai-create-v2.reserve-mint "test-collection" "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" 1)
;  (env-gas "table")
(expect-that "Amounts were transferred"
  (= [995.0 5.0 1045.0])
  [
    (coin.get-balance "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce")
    (coin.get-balance "KAIBANK")
    (coin.get-balance "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652")
  ]
)

(commit-tx)


(begin-tx "Create Marmalade Token for 2cd")
(env-keys ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"])
(env-data {
  "mg": {"keys": ["2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"], "pred": "keys-all"}
  ,"creatorGuard":  {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce", "2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"], "pred": "keys-any"}
, "collection_id": "collection:oqjdizj3K-xjeEyYytBfqwjm4O7xtYT7UnjiBhJjv_s"
})
(env-sigs [{
  'key: "048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"
  ,"caps": [
    (marmalade-v2.ledger.MINT "t:2Set0w8pRLFPB5Yv2bvNWUtZTtjDOY8Uwfaw6FzPIUU" "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" 1.0)
  , (free.kadenai-create-v2.MINTPROCESS "test-collection")
  , (marmalade-v2.ledger.CREATE-TOKEN "t:2Set0w8pRLFPB5Yv2bvNWUtZTtjDOY8Uwfaw6FzPIUU" (read-keyset 'creatorGuard))
  ]
}])
(free.kadenai-create-v2.create-marmalade-token "ipfs//test2" 0 "test-collection" 2 (marmalade-v2.util-v1.create-policies marmalade-v2.util-v1.DEFAULT_COLLECTION))
(commit-tx)

(begin-tx "Create Marmalade Token")
(env-keys ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"])
(env-data {
  "mg": {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"], "pred": "keys-all"}
  ,"creatorGuard":  {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce", "2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"], "pred": "keys-any"}
  ,"newkeys":  {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce", "bob-key"], "pred": "keys-any"}
,"collection_id": "collection:oqjdizj3K-xjeEyYytBfqwjm4O7xtYT7UnjiBhJjv_s"
})
(env-sigs [{
  'key: "048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"
  ,"caps": [
    (marmalade-v2.ledger.MINT "t:pqMLRltXo7Lfqo4O4atKRqNuROhbrwwfpKCfPVvjsGs" "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" 1.0)
  , (free.kadenai-create-v2.MINTPROCESS "test-collection")
  , (marmalade-v2.ledger.CREATE-TOKEN "t:pqMLRltXo7Lfqo4O4atKRqNuROhbrwwfpKCfPVvjsGs" (read-keyset 'creatorGuard))
  ]
}])
(free.kadenai-create-v2.create-marmalade-token  "ipfs//test1" 0 "test-collection" 1 (marmalade-v2.util-v1.create-policies marmalade-v2.util-v1.DEFAULT_COLLECTION))
(commit-tx)
 

(begin-tx "Gas Testing")
(env-gasmodel "table") (env-gaslimit 1500000) (env-gas 0) 
(free.kadenai-create-v2.get-unrevealed-tokens-for-collection "test-collection")
(env-gas)
(commit-tx)


(begin-tx "add to whitelist")
(env-keys ["ku-ops"])
(free.kadenai-create-v2.add-whitelist-to-collection "test-collection" [{"tierId":"tier1", "accounts":["alice"]}])
(free.kadenai-create-v2.get-wl-collection)

(commit-tx)

(begin-tx "Free Mint")
(env-keys ["alice-key"])
(env-chain-data { "block-time": (time "2024-01-05T20:00:00Z")})
(free.kadenai-create-v2.get-current-tier-for-collection "test-collection")
(free.kadenai-create-v2.reserve-mint "test-collection" "alice" 1)

(commit-tx)


(begin-tx "add tiers")
(env-keys ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"])
(env-data {
  "tier": [
    {
      "tierId": "tier0",
      "tierType": "PUBLIC",
      "startTime": {"time": "2023-01-03T20:00:00Z"},
      "endTime": {"time": "2024-01-03T00:00:00Z"},
      "cost": 50.0,
      "limit": -1,
      "currencyType": "USD"
    },
    {
      "tierId": "tier1",
      "tierType": "WL",
      "startTime": {"time": "2024-01-04T00:00:01Z"},
      "endTime": {"time": "2024-01-09T00:00:00Z"},
      "cost": 0.0,
      "limit": 2,
      "currencyType": "KDA"
    },
    {
      "tierId": "tierTest",
      "tierType": "WL",
      "startTime": {"time": "2024-01-12T00:00:00Z"},
      "endTime": {"time": "2024-01-15T00:00:00Z"},
      "cost": 0.0,
      "limit": 1,
      "currencyType": "KDA"
    }],
    "ac": ["bob, alice"]
})

(free.kadenai-create-v2.update-collection-tiers "test-collection" (read-msg 'tier))
(free.kadenai-create-v2.add-whitelist-to-collection "test-collection" [{"tierId":"tierTest", "accounts":(read-msg 'ac)}])

(commit-tx)



(begin-tx "admin mint")
(env-chain-data {"block-time": (time "2024-01-12T00:00:00Z")})
(env-data {
  "ks": {
    "keys": ["alice-key"],
    "pred": "keys-all"
  },
  'ac: ["alice, bob"]
})
(env-keys ["ku-ops"])
;  (free.kadenai-create-v2.admin-mint "test-collection" "alice" (read-keyset 'ks) 1)
;  (free.kadenai-create-v2.admin-mint "test-collection" "bob" (read-keyset 'ks) 1)
;  (free.kadenai-create-v2.admin-mint "test-collection" "bob" (read-keyset 'ac) 1)
(free.kadenai-create-v2.admin-mint "test-collection" "alice" (read-keyset 'ac) 1)


(free.kadenai-create-v2.get-wl-collection)

(commit-tx)

;  (begin-tx "Free Mint")
;  (env-keys ["alice-key"])
;  (free.kadenai-create-v2.get-current-tier-for-collection "test-collection")
;  (free.kadenai-create-v2.reserve-mint "test-collection" "alice" 1)

;(coin.rotate "w:h7EqxsXk-ejhMXZaUZfnQXqn_cFRlBRUcAAZ-7-_qqY:keys-any" (read-keyset 'newkeys))




;  (begin-tx "offer")
;  (env-hash (hash "offer-quote-only-1"))

;  (env-chain-data {"block-time": (time "2023-07-20T11:26:35Z")})
;  (env-data {
;    "token-id": "t:6Ms0Chkvosh8-BfyESpDzXLhwgDz_uOQ4CUxgW95cGc"
;    ,"quote": {
;      "spec": {
;      "fungible": coin
;     ,"price": 5.0
;     ,"amount": 1.0
;     ,"seller-fungible-account": {
;        "account": "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"
;        ,"guard": {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"], "pred": "keys-all"}
;    }
;  }
;     ,"seller-guard": {"keys": ["048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"], "pred": "keys-all"}
;     ,"quote-guards": [{"keys": ["market"], "pred": "keys-all"}]
;    }
;    })
  
;  (env-sigs [
;    { 'key: "048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce"
;  , 'caps: [
;    (marmalade-v2.ledger.OFFER "t:6Ms0Chkvosh8-BfyESpDzXLhwgDz_uOQ4CUxgW95cGc" "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" 1.0 (time "2023-07-22T11:26:35Z"))]  
;  }])

;  (marmalade-v2.ledger.sale (read-msg 'token-id) "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" 1.0 (time "2023-07-22T11:26:35Z"))
;  ;  (commit-tx)

;  (env-data {
;    "buyer": "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"
;   ,"buyer_fungible_account": "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"
;   ,"buyer-guard": {"keys": ["2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"], "pred": "keys-all"}
;   ,"marketplace-fee": {"marketplace-account": "", "mk-fee-percentage": 0.0 } 
;  })
  
;  (test-capability (coin.COINBASE))
;  (coin.coinbase "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" (read-keyset 'buyer-guard) 5.0)

;  (env-sigs
;    [{'key: "2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"
;     ,'caps: [
;       (marmalade-v2.ledger.BUY "t:6Ms0Chkvosh8-BfyESpDzXLhwgDz_uOQ4CUxgW95cGc" "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652"  1.0 (time "2023-07-22T11:26:35Z") "v86vqj0OkIZQfD3XGETjij1sLjJH7Q6GZBZJeytDsEo")
;       (marmalade-v2.ledger.SALE_PRIVATE "v86vqj0OkIZQfD3XGETjij1sLjJH7Q6GZBZJeytDsEo")
;       (coin.TRANSFER "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" "c:YfM3DHcNV4AYj8M_wRSJquHYq2Lvikvy5O00K_GLc3s" 5.0)
;      ]}])
;      ;  (env-hash (hash "offer-royalty-0"))
;      ;  (marmalade-v2.ledger.buy "t:ozvVxVAI8rhLUwlNyCJpa6GwZFGM0MqhWO-3EcSF2as" "k:048ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce" "k:2c8d728e9f7faa69e432d0753907a4e84719f6a570d56f086c8616ac22f87652" (read-msg "buyer-guard") 1.0 "v86vqj0OkIZQfD3XGETjij1sLjJH7Q6GZBZJeytDsEo")

;      (expect "Buy succeeds"
;      true
;      (continue-pact 1))
;   (commit-tx)















  ; used for all tests, just make sure util has true/false as you want
;  (hash { "uri": "ipfs://howdydoda/1", "precision": 0, "policies": (marmalade-v2.util-v1.create-policies marmalade-v2.util-v1.DEFAULT)LICIES})
;  (hash { "uri": "ipfs://howdydoda/2", "precision": 0, "policies": (marmalade-v2.util-v1.create-policies marmalade-v2.util-v1.DEFAULT)LICIES})
;  (hash { "uri": "ipfs://howdydoda/3", "precision": 0, "policies": (marmalade-v2.util-v1.create-policies marmalade-v2.util-v1.DEFAULT)LICIES})

; collection test
;  (hash [
;  "t:8-MkQgwqJ0j5nxpkRs0YYZkRmYZhCN1awxve4i7SuxU",
;  "t:QS5-JZvA2ZbKa4hesCtsMeV_ak3sEUWZFpr-3svlVcE",
;  "t:WB0WneAuhXftRLzNFvRFaW-M4JNIoh-wU1IvLMZMjz0"])

;  "emjZIM8krClpC5L8B33vAu8LD7zdap-m2uXM1a9jQbk"
; "EoHS7a0lESX6j7bVmF-CdiCX8z_EUCuSTsq1DptmneU"

; royalty test
;  (hash [
;  "t:mOKmJuy84oxnOkgQyLqikXMTRiC0tr03CtwqxhMbStY",
;  "t:RlRzTnf2chXGLnKO88IBAvkFRc0PQ9EjBymKyzihs7Y",
;  "t:QG9tcj0tlUu9-hatkhefXOeJlA-U-s9iwjoaUxmOUk4"
;  ])
;  "IPJ46HBWNS1Dh5sXcbIpuNFC6gSGs18bqrHUCB6GVzs"

; Collection test-collection hashed.
; collection:cxZkDVFSwKpcjd4K4ncAHfFJlZzwUBOk48CclhPceJc


